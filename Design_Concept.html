      <!DOCTYPE html>
      <html lang="en">
      <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Photorealistic Office Render Prompt Builder</title>
        <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
        <style>
          body {
            font-family: Arial, sans-serif;
            /* font-size: 18px; */
            padding: 1rem;
            background-color: #111;
            color: white;
            overflow: hidden;
          }

 
      .container {
        display: flex;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
      }

      .scrollable-form {
          padding: 1rem 0;
          /* max-height: 90vh; */
          max-height: 92%;
          overflow-y: auto;
          flex: 0 0 35%;
          padding-right: 0.5rem; /* âœ… Reduce padding */
          margin-right: 0; /* âœ… No extra margin */
          box-sizing: border-box; /* âœ… Ensures padding doesn't add to width */
          max-width: 20%;
          }

          .form-group textarea{
            max-width: 95%;
          }
          

          
          /* Scrollbar */


          /* Applies to all scrollbars in WebKit-based browsers */
          ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
          }

          ::-webkit-scrollbar-track {
            background-color: #1a1a1a;
            border-radius: 10px;
          }

          ::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 10px;
            border: 2px solid #1a1a1a; /* creates spacing around thumb */
            transition: background-color 0.3s ease;
          }

          ::-webkit-scrollbar-thumb:hover {
            background-color: #888;
          }

          /* Optional: Fade into background */
          ::-webkit-scrollbar-corner {
            background-color: transparent;
          }


          .form-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
          }





          select[multiple], textarea, select, input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid #666;
            background: black;
            color: #A2A2A2;
            /* font-size: 16px; */
          }
          



          .button-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
          }
          button {
            padding: 0.5rem 1.5rem;
            border-radius: 5px;
            font-weight: bold;
            border: none;
            cursor: pointer;
          }
          




      /* new */



      .pinterest-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      }

      .pinterest-row input {
      flex: 1;
      padding: 0.5rem 1rem;
      background-color: #1a1a1a; /* Dark background */
      color: #ddd; /* Light text */
      border: 1px solid #444; /* Subtle border */
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border 0.2s ease, background-color 0.2s ease;
      }

      /* Optional: focus effect */
      .pinterest-row input:focus {
      background-color: #222;
      border-color: #666;
      }


      .pinterest-row button {
        background-color: #E60023;
        color: white;
        font-weight: bold;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
      }

      .preview-placeholder {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #aaa;
        /* font-size: 16px; */
        text-align: center;
        pointer-events: none;
        user-select: none;
      }

      #furniture{
        overflow-y: auto;
        padding-right: 0.5rem;      /* Reduce padding */
        width: 100%;                /* Let it fill available width */
        box-sizing: border-box;  
      }

      .output-section {
        display: flex;
        flex-direction: column;
        width: 100%;
        overflow: hidden;
        margin: 1rem;
        padding-bottom: 2rem;
      }

      .output-main {
        display: flex;
        flex-grow: 1;
        max-height: 89%;
        overflow: hidden;
        gap: 1rem;
        padding-right:1rem;
        box-sizing: border-box;
      }



      .label-tag {
        padding: 0.5rem 0.75rem;
        border-radius: 16px;
        /* font-size: 14px; */
        background-color: #666;
        color: white;
        display: inline-block;
        margin: 0.25rem;
        max-width: 220px;
        word-break: break-word;
        line-height: 1.3;
      }

      .label-tag .remove {
        margin-left: 0.5rem;
        color: #bbb;
        cursor: pointer;
        font-weight: bold;
      }

      .form-card {
        background-color: #1b1b1b;
        padding: 1rem;
        border-radius: 10px;
        border: 1px solid #444;
        margin-bottom: 1rem;
      }

      .form-card-header {
        font-weight: bold;
        /* font-size: 16px; */
        margin-bottom: 0.5rem;
        color: #ccc;
      }




      .prompt-wrapper {
        flex: 0.85;
        height: 100%;
        overflow: auto;
        position: relative;
      }

      .output {
        font-family: Arial, sans-serif;
        width: 100%;
        height: 100%;
        resize: none;
        /* padding: 1rem; */
        /* font-size: 16px; */
        background: black;
        color: #A2A2A2;
        border-radius: 8px;
        border: 1px solid #555;
        box-sizing: border-box;
        min-height: 100%;
      }

      .labels-box {
        width: 100%;
        flex: 0.37;
        background: black;
        color: white;
        border-radius: 8px;
        border: 1px solid #555;
        padding: 1rem;
        border-radius: 10px;
        overflow-y: auto;
        height: 100%;
        box-sizing: border-box;
        display: flex;
        flex-wrap: wrap;            /* Wrap tags to new lines */
        gap: 0.5rem;                /* Space between tags */
        align-content: flex-start;
      }

      .label-tag .remove {
        margin-left: 0.5rem;
        color: #bbb;
        cursor: pointer;
        font-weight: bold;
      }

      .output-top {
        flex: 0 0 auto;
        margin-bottom: 0.5rem;
      }

      .output-middle {
        flex: 1 1 auto;
        overflow: auto;
      }

      .output-bottom {
        flex: 0 0 auto;
        display: flex;
        gap: 0.5rem;
        align-items: center;
        padding-top: 0.5rem;
        margin-right: 1rem;
        margin-top: 1rem;
      }

      .form-group {
        /* margin-bottom: 1.5rem; */
        background-color: #111;
        padding: 1rem;
        border: 1px solid #444;
        border-radius: 8px;
      }

      .form-group h3 {
        margin-top: 0.25rem;
        padding-bottom: 0.5rem;
        /* font-size: 20px; */
        font-weight: bold;
        color: #A2A2A2;
        margin-bottom: 1px;
        border-bottom: 2px solid #555; /* Draw the horizontal line */
      }

      


      .form-card-header {
      font-weight: bold;
      /* font-size: 20px; */
      margin-bottom: 0.5rem;
      color: #ccc;
      }


      label {
        display: block;
        /* margin-top: 1rem; */
        margin-bottom: 0.5rem;
        font-weight: bold;
        color: #ccc;
        /* font-size: 20px; */
      }

      select[multiple] {
        width: 100%;
        height: auto;
        padding: 0.5rem;
        background-color: black;
        color: #A2A2A2;
        border: 1px solid #666;
        border-radius: 5px;
      }

      .label-tag .remove {
        margin-left: 0.5rem;
        color: #ccc;
        font-weight: bold;
        cursor: pointer;
      }

        .grayed-out {
      pointer-events: none;
      opacity: 0.4;
      transition: opacity 0.3s ease;
    }


    .search-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    color: #A2A2A2;
    }

    

    .form-card-header i.fa-pinterest {
    margin-left: 8px;
    transition: transform 0.2s ease;
    }

    .form-card-header i.fa-pinterest:hover {
    transform: scale(1.2);
    }


    .collapsible-header {
    font-weight: bold;
    /* font-size: 22px; */
    margin-top: 0.5rem;
    cursor: pointer;
    color: white;
    border-bottom: 2px solid #555;
    padding-bottom: 1rem;
    }



.toggle-icon {
  font-size: 16px;
  transition: transform 0.2s ease;
}

.collapsible-content {
  margin-top: 0.75rem;
}

.toggle-icon {
  color: grey; /* ðŸŒŸ Teal or use #FFD700 for gold */
  font-size: 20px;
  transition: transform 0.2s ease;
}

.btn {
  background-color: #00a67e;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  margin-left: 10px;
}

.label-tag {
  padding: 0.5rem 0.75rem;
  border-radius: 16px;
  /* font-size: 14px; */
  background-color: #666;
  color: white;
  display: inline-block;
  margin: 0.25rem;
  max-width: 220px;
  word-break: break-word;
  line-height: 1.3;
  cursor: pointer;              /* ðŸ‘ˆ ADD THIS */
  transition: background-color 0.2s ease;
}

.label-tag:hover {
  background-color: #888;       /* Optional hover effect */
}



.label-tag:not(.remove) {
  cursor: pointer;
}






.button-group {
  display: flex;
  gap: 1rem;
  display: flex;
  justify-content: flex-start; /* ðŸ‘ˆ All buttons start from the left */
  gap: 1rem;       
  margin-right: 2rem;
}

/* Set the same font size across all text elements */
*{
  font-size: 14px ;
}

button {
  font-size: 14px !important;
}

label {
  color: #A2A2A2 !important;
  margin-top: 1rem;
}

label + textarea {
  margin-top: 0.75rem;
  /* margin-bottom: 1rem; */
  }


element.style{
margin-top: 0px;
}

.search-wrapper select {
  margin-top: 0.5rem; /* or 0.75rem for more space */
}


.button-row button,
.button-group button {
  font-size: 12px !important; /* Or 11px if you want even smaller */
  padding: 4px 10px;          /* Also reduce padding to shrink the button height */
}




.tab-bar {
  display: flex;
  gap: 8px;
  padding: 4px;
  background: transparent;
  font-size: 14px;  
  font-weight: 500;
}

.tab {
  flex: 1;
  text-align: center;
  padding: 8px 12px;
  background: #333;      /* Unselected background */
  color: #eee;          /* Unselected text */
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}

.tab.active {
  background: white;     /* Selected background */
  color: black;          /* Selected text */
}


.tab:hover {
  background: #555;
  color: #fff;
}

.tab.active::before {
  content: "âœ“";
  margin-right: 6px;
}





.floating-chatgpt-btn {
  position: absolute;
  bottom: 16px;
  right: 16px;
  background: #10a37f;
  color: white;
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.4);
  transition: background 0.2s ease, transform 0.1s ease;
}

.floating-chatgpt-btn:hover {
  background: #12b087;
  transform: translateY(-1px);
}






.quantity-container {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
  margin-top: 0.5rem;
}

.quantity-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background-color: #222; /* dark background */
  border: 1px solid #444;
  border-radius: 6px;
  padding: 0.4rem 0.6rem;
}

.quantity-label {
  color: #ddd;
  font-size: 14px;
  flex: 1;
}

.quantity-input {
  width: 60px;
  background-color: #111;
  border: 1px solid #555;
  color: #fff;
  padding: 0.3rem;
  border-radius: 4px;
  text-align: center;
}


textarea::placeholder {
  color: rgba(75, 75, 75, 0.664); /* Bright cyan placeholder text */
  opacity: 1;     /* Optional: ensures full color visibility */
}





.floating-btn-container {
  position: absolute;
  bottom: 16px;
  right: 16px;
  display: flex;
  gap: 10px;
  z-index: 10;
}

.floating-chatgpt-btn {
  background: #10a37f;
  color: white;
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.4);
  transition: background 0.2s ease, transform 0.1s ease;
  position: relative; /* override old absolute */
}



.floating-chatgpt-btn.reset-btn {
  background-color: #444;
}


        </style>
      </head>
      <body>
      <!-- <h1>Photorealistic Office Render Prompt Builder</h1> -->
       <div class="tab-bar">
         <div class="tab "id="Client">Client Persona</div>
         <div class="tab " id="Zoning">Zoning Insights</div>
         <div class="tab active">Design Concept</div>
         <div class="tab" id="Material">Material Board</div>
       </div>
       <div class="container">
         <div class="scrollable-form">
           <div id="formContainer" class="form-section"></div>
         </div>

         <div class="output-section">
           <div class="output-main">
             <div class="prompt-wrapper">
               <textarea class="output" id="finalPrompt"></textarea>

               <div class="floating-btn-container">

                 <button class="floating-chatgpt-btn reset-btn" onclick="resetAllFields()">
                  Reset All
                 </button>
                 <button class="floating-chatgpt-btn" id="openCustomGPT">
                   Create with AI
                 </button>
               </div>
             </div>

            

            <div class="labels-box" id="labelsBox">
              <!-- labels get injected here -->
            </div>
          </div>

          <div class="output-bottom pinterest-row">
            <input type="text" id="pinterestSearch" placeholder="Search query for Pinterest"/>
            <button
              onclick="window.open('https://www.pinterest.com/search/pins/?q=' + encodeURIComponent(document.getElementById('pinterestSearch').value))">
              Open in Pinterest
            </button>
            
          </div>
        </div>
      </div>


      <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>


     <script>







function resetAllFields() {
  if (confirm("Clear all fields and reset the form?")) {
    localStorage.clear(); // fully clear all keys
    sessionStorage.setItem('resetNow', 'true'); // temporary flag
    location.reload(); // force reload
  }
}



        const optionQuantities = {};
window.optionQuantities = optionQuantities;


function saveToLocalStorage() {
  const inputs = document.querySelectorAll('select, textarea');
  const savedData = {};

  inputs.forEach(el => {
    const key = el.getAttribute('data-header') || el.id;
    if (!key) return;

    if (el.tagName === 'SELECT' && el.multiple) {
      savedData[key] = Array.from(el.selectedOptions).map(opt => opt.value);
    } else if (el.tagName === 'TEXTAREA') {
      savedData[key] = el.value;
    }
  }); 

  localStorage.setItem('formValues', JSON.stringify(savedData));
}



function saveQuantitiesToLocalStorage() {
  localStorage.setItem('optionQuantities', JSON.stringify(optionQuantities));
}

// Call this after any change
document.addEventListener('change', saveToLocalStorage);
document.addEventListener('input', saveToLocalStorage);




window.addEventListener('beforeunload', (event) => {
  if (window.skipUnloadWarning) return; // Allow silent navigation when flag is set

  const savedData = JSON.parse(localStorage.getItem('formValues') || '{}');

  const isFormDirty = Array.from(document.querySelectorAll('select, textarea'))
    .some(el => {
      const key = el.getAttribute('data-header') || el.id;
      if (!key) return false;

      const savedVal = savedData[key];

      if (el.tagName === 'SELECT' && el.multiple) {
        const currentVal = Array.from(el.selectedOptions).map(opt => opt.value);
        return JSON.stringify(currentVal) !== JSON.stringify(savedVal || []);
      } else {
        const currentVal = (el.value || '').trim();
        return currentVal !== (savedVal || '').trim();
      }
    });

  if (isFormDirty) {
    event.preventDefault();       // Required for some browsers
    event.returnValue = '';       // Required for Chrome + modern browsers
  }
});







































     
         document.getElementById("Client").addEventListener("click", function() {
  window.location.href = "index.html"});

  document.getElementById("Zoning").addEventListener("click", function() {
  window.location.href = "Zoning_insights.html"});
  
  document.getElementById("Material").addEventListener("click", function() {
  window.location.href = "Material.html"});




     document.getElementById("openCustomGPT").addEventListener("click", function () {
const prompt = document.getElementById("finalPrompt").value.trim();
if (!prompt) {
alert("Prompt is empty!");
return;
}

// Copy to clipboard first
navigator.clipboard.writeText(prompt).then(() => {
const customGPTURL = "https://chatgpt.com/g/g-686e0c310aac81919183673ef60ae018-1-client-persona-gpt";
window.open(customGPTURL, "_blank");
alert("âœ… Prompt copied to clipboard. Just paste (Ctrl+V) into the chat.");
}).catch(() => {
alert("âŒ Failed to copy prompt. Please copy it manually.");
});
});




//       document.getElementById("openCustomGPT").addEventListener("click", function () {
// const prompt = document.getElementById("finalPrompt").value.trim();
// if (!prompt) {
// alert("Prompt is empty!");
// return;
// }

// // Copy to clipboard first
// navigator.clipboard.writeText(prompt).then(() => {
// const customGPTURL = "https://chat.openai.com/g/g-68512d8ce4208191b216c8344e406aea-design-brief-testing";
// window.open(customGPTURL, "_blank");
// alert("âœ… Prompt copied to clipboard. Just paste (Ctrl+V) into the chat.");
// }).catch(() => {
// alert("âŒ Failed to copy prompt. Please copy it manually.");
// });
// });

  
//       document.getElementById("moodboardgpt").addEventListener("click", function () {
// const prompt = document.getElementById("finalPrompt").value.trim();
// if (!prompt) {
// alert("Prompt is empty!");
// return;
// }

// // Copy to clipboard first
// navigator.clipboard.writeText(prompt).then(() => {
// const customGPTURL = "https://chatgpt.com/g/g-685d46734f708191a9f3e33e1a5f1be3-materialboard-creator";
// window.open(customGPTURL, "_blank");
// alert("âœ… Prompt copied to clipboard. Just paste (Ctrl+V) into the chat.");
// }).catch(() => {
// alert("âŒ Failed to copy prompt. Please copy it manually.");
// });
// });




    const finalPrompt = document.getElementById('finalPrompt');
    const formSection = document.querySelector('.scrollable-form');
    const Section = document.querySelector('.labels-box');

    let isManuallyEdited = false;
    let typingTimeout;

    finalPrompt.addEventListener('input', () => {
      isManuallyEdited = true;
      formSection.classList.add('grayed-out');
      Section.classList.add('grayed-out'); // for the right side as well

      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        formSection.classList.remove('grayed-out');
      }, 2000000); // Remove grey after 2 seconds of no typing


    });


    






      function normalizeId(name) {
        return name.replace(/\s+/g, '').toLowerCase();
      }
        
      // const sheetURL = 'https://docs.google.com/spreadsheets/d/1qXN1MR1pW3laS1wH_FI3vPblg3ANcqCMWVoGl0H7wek/export?format=csv';
      const sheetURL = 'https://docs.google.com/spreadsheets/d/1TtxfPpIIYBjzP32-9n9snZbNoCU69mSvYVbA3uAgGcY/export?format=csv&gid=1370946748';



      
      window.onload = async function () {

        const response = await fetch(sheetURL);
        const csvText = await response.text();
        const parsed = Papa.parse(csvText, { header: false });
        const data = parsed.data;

        const parentHeaders = data[0];
        const childHeaders = data[1];
        const typeRow = data[2]; // This is now the row that tells us the type (1, 2, 3)
        const contentRows = data.slice(2);
        const valueRows = data.slice(4); // Actual content starts from 4th row now
        const pinterestLabels = data[3]; // ðŸ‘ˆ This is the new row you want to use
        const quant = data.slice(4)
        const promptLabels = data[1]; // âœ… clean labels from Row 2
        window.row4Values = data[3]; // Row 4 = index 4

        window.promptLabels = promptLabels; // âœ… make accessible globally
        
const pinterestBlockFlags = data[3].map(cell => {
  return cell?.trim().toLowerCase() === 'text' && cell.toLowerCase() === cell && cell.length > 0;
});

window.pinterestBlockFlags = data[3].map((_, i) => {
  // block only if cell background was red
  return data[3][i]?.trim().toLowerCase() === 'text' && data[3][i].toLowerCase() === data[3][i];
});



        // const parentHeaders = data[0]; // Row 1 (still header group)
        // const childHeaders = data[1]; // Row 2 (still header names)
        // const typeRow = data[3]; // Row 4 â€” NEW type row
        // const valueRows = data.slice(4); // Row 5 onwards â€” values begin here


        const grouped = {};
        childHeaders.forEach((child, i) => {
          const parent = parentHeaders[i]?.trim();
          if (!parent || !child) return;
          if (!grouped[parent]) grouped[parent] = [];
          grouped[parent].push({ name: child.trim(), index: i });
        });

        const container = document.getElementById('formContainer');

        for (const [parent, children] of Object.entries(grouped)) {
        const group = document.createElement('div');
        group.className = 'form-group';

        const header = document.createElement('div');
        header.className = 'form-card-header collapsible-header';
        header.innerHTML = `
  ${parent}
  <img 
    src="data:image/png;base64,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" 
    class="toggle-icon" 
    style="float:right;cursor:pointer;width:16px;height:16px;transition:transform 0.2s ease;"
  >`;


        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'collapsible-content';
        // contentWrapper.style.display = 'none'; // ðŸ”» Hide by default


        // Toggle collapse on click
        header.addEventListener('click', () => {
  const isVisible = contentWrapper.style.display !== 'none';
  contentWrapper.style.display = isVisible ? 'none' : 'block';

  const icon = header.querySelector('.toggle-icon');
  icon.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
});


        group.appendChild(header);
        group.appendChild(contentWrapper);

        children.forEach(({ name, index }) => {
        const label = document.createElement('label');
        label.setAttribute('for', name);
        // Extract text inside [ ]
        const bracketMatch = name.match(/\[(.*?)\]/);
        label.textContent = bracketMatch ? bracketMatch[1].trim() : name.trim();

        contentWrapper.appendChild(label);


        const id = normalizeId(name);
        const hasQuantityMarker = contentRows.some(row =>
        row[index]?.trim().toLowerCase() === 'quantity'
        );

        const allValues = quant
  .map(row => row[index]?.trim())
  .filter(v => !!v && !['quantity', 'dropdown', 'text'].includes(v.toLowerCase()));


        const uniqueOptions = [...new Set(allValues)];

        let fieldElement;
if (typeRow[index]?.toLowerCase() === 'text') {
  // Pull placeholder from row 4 (valueRows[0])
  const placeholderText = valueRows[0]?.[index]?.trim() || 'Enter value here';

  const textarea = document.createElement('textarea');
  textarea.setAttribute('id', id);
  textarea.setAttribute('rows', 4);
  const pinterestLabel = pinterestLabels[index]?.trim() || name;
textarea.setAttribute('data-pinterest', pinterestLabel); 

  textarea.style.marginBottom = '0.75rem';
  textarea.placeholder = placeholderText;

  textarea.addEventListener('input', () => {
    generatePrompt();
    updateStructuredView();
    updatePinterestQuery();
  });

  fieldElement = textarea;


    } else {
      // âœ… Create search wrapper
      const searchWrapper = document.createElement('div');
      searchWrapper.classList.add('search-wrapper');

      const searchInput = document.createElement('input');
      searchInput.setAttribute('type', 'text');
      searchInput.setAttribute('placeholder', 'Search...');
      searchInput.classList.add('dropdown-search');

      const searchButton = document.createElement('button');
      searchButton.innerHTML = `<i class="fas fa-search"></i>`;
      searchButton.classList.add('search-btn');


      






      const select = document.createElement('select');
      select.setAttribute('id', id);
      select.setAttribute('multiple', true);
      const pinterestLabel = pinterestLabels[index]?.trim() || name;
select.setAttribute('data-pinterest', pinterestLabel); // âœ… ADD THIS

      select.style.marginTop = '0.5rem';

      

      uniqueOptions.forEach(value => {
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = value;
        select.appendChild(opt);
      });

      // Filter logic ðŸ”
      searchInput.addEventListener('input', () => {
        const filter = searchInput.value.toLowerCase();
        Array.from(select.options).forEach(opt => {
          opt.style.display = opt.textContent.toLowerCase().includes(filter) ? '' : 'none';
        });
      });

      searchButton.addEventListener('click', () => {
        const filter = searchInput.value.toLowerCase();
        Array.from(select.options).forEach(opt => {
          opt.style.display = opt.textContent.toLowerCase().includes(filter) ? '' : 'none';
        });
      });
      select.addEventListener('change', () => {
      moveSelectedOptionsToTop(select);
      if (quantityContainer) {
      updateQuantitiesForSelect(select, quantityContainer, id);

      }


      generatePrompt();
      updateStructuredView();
      updatePinterestQuery();
      });


      searchInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault(); // Prevent form submission

        const inputValue = searchInput.value.trim();
        if (!inputValue) return;

        const exists = Array.from(select.options).some(option =>
          option.text.toLowerCase() === inputValue.toLowerCase()
        );

        if (!exists) {
          const newOption = document.createElement('option');
          newOption.value = inputValue;
          newOption.text = inputValue;
          newOption.selected = true;
          select.appendChild(newOption);
        } else {
          // If it exists, select it
          Array.from(select.options).forEach(option => {
            if (option.text.toLowerCase() === inputValue.toLowerCase()) {
              option.selected = true;
            }
          });
        }

        // Reset input and regenerate prompt
        searchInput.value = '';
        moveSelectedOptionsToTop(select);
        generatePrompt();
        updateStructuredView();
        updatePinterestQuery();
      }
    });


    // Create top row for label + search input in same row
    const topRow = document.createElement('div');
    topRow.style.display = 'flex';
    topRow.style.alignItems = 'center';
    topRow.style.justifyContent = 'space-between';
    // topRow.style.marginTop = '15px';
    topRow.style.gap = '1rem';

    // Create and style label
    label.style.color = '#ccc';
    label.style.fontWeight = 'bold';
    label.style.flex = '1';

    // Wrapper for search input + icon
    const inputWrapper = document.createElement('div');
    inputWrapper.style.display = 'flex';
    inputWrapper.style.alignItems = 'center';
    inputWrapper.style.flex = '1';
    inputWrapper.style.gap = '6px'; // gap between input and icon

    // Style search input
    searchInput.style.flex = '1';
    searchInput.style.minWidth = '120px';
    searchInput.style.padding = '6px 8px';
    searchInput.style.border = '1px solid #444';
    searchInput.style.borderRadius = '4px';
    searchInput.style.background = '#222';
    searchInput.style.color = '#fff';


    // Build structure
    inputWrapper.appendChild(searchInput);
    // inputWrapper.appendChild(searchButton);
    topRow.appendChild(label);
    topRow.appendChild(inputWrapper);
    group.appendChild(topRow);  // âœ… fixed



    searchWrapper.appendChild(topRow);

// Wrap the select in a div to add spacing
const selectWrapper = document.createElement('div');
// selectWrapper.style.marginTop = '0.75rem'; // Adjust spacing here
selectWrapper.style.marginBottom = '1rem';
selectWrapper.appendChild(select);

// Create container for dynamic quantity inputs
let quantityContainer = null;
if (hasQuantityMarker) {
  const qc = document.createElement('div');
  qc.className = 'quantity-container';
  qc.style.display = 'flex';
  qc.style.flexDirection = 'column';
  qc.style.gap = '0.3rem';
  qc.style.marginTop = '0.5rem';
  quantityContainer = qc;

  // Append below the select
  searchWrapper.appendChild(quantityContainer);
}


searchWrapper.appendChild(selectWrapper);


    fieldElement = searchWrapper;


    }

        fieldElement.setAttribute('data-header', name); // âœ… Set the label for dynamic Pinterest queries

        contentWrapper.appendChild(fieldElement);



        
      });


          container.appendChild(group);
        }

        autosizePlaceholderTextareas(-10);// adds 6px of extra space
      };

function restoreFromLocalStorage() {
  const saved = localStorage.getItem('formValues');
  if (!saved) return;
  const data = JSON.parse(saved);

  document.querySelectorAll('select, textarea').forEach(el => {
    const key = el.getAttribute('data-header') || el.id;
    if (!key || !(key in data)) return;

    if (el.tagName === 'SELECT' && el.multiple && Array.isArray(data[key])) {
      Array.from(el.options).forEach(option => {
        option.selected = data[key].includes(option.value);
      });
    } else if (el.tagName === 'TEXTAREA') {
      el.value = data[key];
    }

    // Trigger UI updates
    el.dispatchEvent(new Event('change'));
  });
}



function restoreQuantitiesFromLocalStorage() {
  const saved = localStorage.getItem('optionQuantities');
  if (!saved) return;

  const parsed = JSON.parse(saved);
  Object.assign(optionQuantities, parsed);

  // ðŸ” After restoring data, refresh the quantity UI and prompt
  document.querySelectorAll('select[multiple]').forEach(select => {
    const fieldId = normalizeId(select.id);
    const container = select.closest('.search-wrapper')?.querySelector('.quantity-container');
    if (container && optionQuantities[fieldId]) {
      updateQuantitiesForSelect(select, container, fieldId);
    }
  });

  generatePrompt(); // âœ… Refresh prompt output after setting quantities
  updateStructuredView?.();
  updatePinterestQuery?.();
}

// Run this after all elements are rendered
const wasReset = sessionStorage.getItem('resetNow') === 'true';

if (!wasReset) {
  setTimeout(() => {
    restoreFromLocalStorage();
    restoreQuantitiesFromLocalStorage();
  }, 1100);
} else {
  sessionStorage.removeItem('resetNow'); // clear flag so next load behaves normally
}






    



      document.getElementById('labelsBox').addEventListener('click', function (e) {
      const tag = e.target.closest('.label-tag');
      if (!tag) return;

      // ðŸ—‘ Remove logic
      if (e.target.classList.contains('remove')) {
      const field = tag.getAttribute('data-field');
      const value = tag.getAttribute('data-value');
      if (field && value) removeLabel(field, value);
      return;
      }

      // ðŸ§  Pinterest search (dynamic, same as icon)
      const section = tag.closest('.form-card');
      const tagElements = section.querySelectorAll('.label-tag');
      if (tagElements.length === 0) return;

      const grouped = {};
      tagElements.forEach(tag => {
      const value = tag.getAttribute('data-value')?.trim();
      const header = tag.getAttribute('data-pinterest')?.trim() || tag.getAttribute('data-header')?.trim();
      if (!grouped[header]) grouped[header] = [];
      grouped[header].push(value);
      });

      const searchParts = Object.entries(grouped).map(([header, values]) => {
      const match = header.match(/\[(.*?)\]/);
      if (match) {
      return header.replace(/\[.*?\]/, values.join(', ')).trim();
      } else {
      return values.join(', ').trim();
      }
      });

      const query = searchParts.join(' ');
      const pinterestURL = `https://www.pinterest.com/search/pins/?q=${encodeURIComponent(query)}`;
      window.open(pinterestURL, '_blank');
      });


  


      


      function dataURLtoFile(dataurl, filename) {
        const arr = dataurl.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) u8arr[n] = bstr.charCodeAt(n);
        return new File([u8arr], filename, { type: mime });
      }


        async function exportToChatGPT() {
        const prompt = document.getElementById('finalPrompt').value;
        const wrappers = document.querySelectorAll('.preview-image-wrapper');

          const labelled = Array.from(wrappers)
            .filter(wrapper => wrapper.querySelector('.image-label') && wrapper.querySelector('img'))
            .map(wrapper => {
              const label = wrapper.querySelector('.image-label').textContent.trim();
              const img = wrapper.querySelector('img');
              const base64 = img.src.split(',')[1]; // Extract base64 only
              return { label, base64 };
            });

          if (labelled.length === 0) {
          // Proceed without images
          const prompt = document.getElementById('finalPrompt').value;
          const chatGPTURL = `https://chatgpt.com/g/g-686e0c310aac81919183673ef60ae018-1-client-persona-gpt`;
          window.open(chatGPTURL, "_blank");
          return;
          }


          const uploads = await Promise.all(labelled.map(async ({ label, base64 }) => {
            try {
              const res = await fetch("https://api.imgbb.com/1/upload", {
                method: "POST",
                body: new URLSearchParams({
                  key: "e4440d61f8e0b97bfe979bf8995476c2", // your API key
                  image: base64
                })
              });
              const data = await res.json();
              if (data.success) {
                const url = data.data.url;
                return `\n ${label} :${url}`;
              } else {
                return `**${label}**: (upload failed)`;
              }
            } catch (e) {
              return `**${label}**: (upload error)`;
            }
          }));

        const combinedPrompt = `${prompt}\n\n${uploads.join("\n\n")}`;
        const chatGPTURL = `https://chat.openai.com/?prompt=${encodeURIComponent(combinedPrompt)}`;
        window.open(chatGPTURL, "_blank");
      }

      // Normalize select options to keep selected at the top
      function moveSelectedOptionsToTop(selectElement) {
        const selected = Array.from(selectElement.selectedOptions);
        const unselected = Array.from(selectElement.options).filter(opt => !opt.selected);

        selectElement.innerHTML = '';

        selected.forEach(opt => {
          const o = new Option(opt.text, opt.value, false, true);
          selectElement.appendChild(o);
        });

        unselected.forEach(opt => {
          const o = new Option(opt.text, opt.value, false, false);
          selectElement.appendChild(o);
        });
      }

      // Hook moveSelectedOptionsToTop on all select changes
      function attachMoveSelectedTop() {
        document.querySelectorAll('select[multiple]').forEach(select => {
          select.addEventListener('change', () => moveSelectedOptionsToTop(select));
        });
      }

      // Ensure it's run after dynamic form generation
      setTimeout(attachMoveSelectedTop, 1000);


        function openInChatGPT() {
        const prompt = document.getElementById('finalPrompt').value.trim();
        if (!prompt) {
          alert("Prompt is empty!");
          return;
        }
        const encodedPrompt = encodeURIComponent(prompt);
        const chatURL = `https://chat.openai.com/?model=text-davinci-003&prompt=${encodedPrompt}`;
        window.open(chatURL, '_blank');
      }

        document.querySelectorAll('select, textarea').forEach(el => {
        el.addEventListener('change', generatePrompt);
      });


function normalizeLabel(label) {
  return label.replace(/\s+/g, '').toLowerCase();
}




function getMultiSelect(labelInBrackets) {
  const normalizedInput = normalizeLabel(labelInBrackets);
  const match = Array.from(document.querySelectorAll('select[multiple]')).find(select => {
    const header = select.getAttribute('data-header') || '';
    const bracket = header.match(/\[(.*?)\]/);
    if (bracket) {
      return normalizeLabel(bracket[1]) === normalizedInput;
    }
    // No brackets: fallback to full header text
    return normalizeLabel(header) === normalizedInput;
  });
  if (!match) return [];
  return Array.from(match.selectedOptions).map(opt => opt.value.trim()).filter(Boolean);
}




function get(labelInBrackets) {
  const normalizedInput = normalizeLabel(labelInBrackets);
  const match = Array.from(document.querySelectorAll('select, textarea')).find(el => {
    const header = el.getAttribute('data-header') || '';
    const bracket = header.match(/\[(.*?)\]/);
    if (bracket) {
      return normalizeLabel(bracket[1]) === normalizedInput;
    }
    return normalizeLabel(header) === normalizedInput;
  });
  if (!match) return '';
  if (match.tagName === 'SELECT') {
    return Array.from(match.selectedOptions).map(opt => opt.value.trim()).join(', ');
  }
  return match.value.trim();
}



function getValueByLabel(labelInBrackets) {
  const normalizedInput = normalizeLabel(labelInBrackets);
  const match = Array.from(document.querySelectorAll('select, textarea')).find(el => {
    const header = el.getAttribute('data-header') || '';
    const bracket = header.match(/\[(.*?)\]/);
    if (bracket) {
      return normalizeLabel(bracket[1]) === normalizedInput;
    }
    return normalizeLabel(header) === normalizedInput;
  });
  if (!match) return [];
  if (match.tagName === 'SELECT' && match.multiple) {
    return Array.from(match.selectedOptions).map(opt => opt.value.trim()).filter(Boolean);
  }
  if (match.tagName === 'TEXTAREA') {
    const val = match.value.trim();
    return val ? [val] : [];
  }
  return [];
}


console.log("ðŸ” generatePrompt triggered");




        
 function generatePrompt() {
  console.log("Field IDs in optionQuantities:", Object.keys(window.optionQuantities));

  const lines = [];

  const allInputs = document.querySelectorAll('select, textarea');

  allInputs.forEach((el, i) => {
    const label = window.promptLabels?.[i]?.trim() ||
                  el.getAttribute('data-pinterest')?.trim() ||
                  el.getAttribute('data-header')?.trim();
    if (!label) return;

    if (window.pinterestBlockFlags && window.pinterestBlockFlags[i] === true) return;


    const fieldId = normalizeId(el.id);
    const quantityMap = window.optionQuantities?.[fieldId] || {};
    const values = [];

    // Handle select with quantity
    if (el.tagName === 'SELECT' && el.multiple) {
      Array.from(el.selectedOptions).forEach(opt => {
        const val = opt.value.trim();
        if (!val) return;
        const qty = quantityMap[val];
        if (qty && Number(qty) > 1) {
          values.push(`${val} (${qty})`);
        } else {
          values.push(val);
        }
      });
    }

    // Handle textarea
    if (el.tagName === 'TEXTAREA') {
      const val = el.value.trim();
      if (val) values.push(val);
    }

    if (values.length > 0) {
      lines.push(`${label}: ${values.join(', ')}`);
    }
  });

 if (!isManuallyEdited) {
  const promptArea = document.getElementById('finalPrompt');
  if (promptArea) {
    promptArea.value = lines.join('\n\n');
  }
}

}


    
    function updateQuantitiesForSelect(selectEl, quantityContainer, fieldId) {
    // Clear previous
    quantityContainer.innerHTML = '';

    const selectedOptions = Array.from(selectEl.selectedOptions);
    if (selectedOptions.length === 0) return;

    if (!optionQuantities[fieldId]) optionQuantities[fieldId] = {};

    selectedOptions.forEach(opt => {
    const val = opt.value.trim();

    if (!optionQuantities[fieldId]) {
  optionQuantities[fieldId] = {};
}
if (!optionQuantities[fieldId][val]) {
  const savedQty = window.optionQuantities?.[fieldId]?.[val];
  optionQuantities[fieldId][val] = savedQty || 1;
}


    const row = document.createElement('div');
    row.className = 'quantity-row'; // NEW CLASS

    const lbl = document.createElement('span');
    lbl.textContent = val;
    lbl.className = 'quantity-label'; // NEW CLASS

    const qty = document.createElement('input');
    qty.type = 'number';
    qty.min = '1';
    qty.value = optionQuantities[fieldId][val];
    qty.className = 'quantity-input'; // NEW CLASS

    qty.addEventListener('input', () => {
    const v = parseInt(qty.value, 10);
    if (!isNaN(v) && v >= 1) {
    optionQuantities[fieldId][val] = v;
 
    generatePrompt();
    saveQuantitiesToLocalStorage();

    updateStructuredView();
    updatePinterestQuery();
    }
    });

    row.appendChild(lbl);
    row.appendChild(qty);
    quantityContainer.appendChild(row);
    });
    }




      setTimeout(() => {
        document.querySelectorAll('select[multiple]').forEach(select => { 
          select.addEventListener('change', generatePrompt);
        });
      }, 500); // slight delay to wait for selects to render


      function updateStructuredView() {
      const groupedContainer = document.getElementById('labelsBox');
      groupedContainer.innerHTML = '';

      const formGroups = document.querySelectorAll('.form-group');
      formGroups.forEach(group => {
      const header = group.querySelector('div');
      if (!header) return;
      const groupTitle = header.childNodes[0].textContent.trim();
      const fields = group.querySelectorAll('select, textarea');

      const validTags = [];

      fields.forEach(el => {
      const fieldId = el.id;
      const inputEl = document.getElementById(fieldId);

      const fieldIndex = window.promptLabels.findIndex(
      lbl => normalizeId(lbl) === normalizeId(fieldId)
      );
      const row4Value = (fieldIndex !== -1) ? (window.row4Values?.[fieldIndex]?.trim()) : null;

      if (!row4Value) return; // ðŸš« Skip field if Row 4 is empty

      if (el.tagName === 'SELECT' && el.multiple) {
      const options = Array.from(el.selectedOptions);
      options.forEach(opt => {
      const value = opt.value.trim();
      if (value) {
      validTags.push({
      field: fieldId,
      value,
      label: row4Value
      });
      }
      });
      } else if ((el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') && el.value.trim()) {
      validTags.push({
      field: fieldId,
      value: el.value.trim(),
      label: row4Value
      });
      }
      });

      // ðŸš« Skip rendering the entire card if no valid tags
      if (validTags.length === 0) return;

      // âœ… Create the card
      const section = document.createElement('div');
      section.classList.add('form-card');

      const title = document.createElement('div');
      title.classList.add('form-card-header');

      // Pinterest Icon
      const pinterestIcon = document.createElement('i');
      pinterestIcon.className = 'fa-brands fa-pinterest';
      pinterestIcon.style.cursor = 'pointer';
      pinterestIcon.style.float = 'right';
      pinterestIcon.title = 'Search on Pinterest';
      pinterestIcon.style.color = '#E60023';
      pinterestIcon.style.fontSize = '20px';

      pinterestIcon.addEventListener('click', () => {
      const tagElements = section.querySelectorAll('.label-tag');
      if (tagElements.length === 0) return;

      const grouped = {};
      tagElements.forEach(tag => {
      const value = tag.getAttribute('data-value').trim();
      const header = tag.getAttribute('data-pinterest')?.trim() || tag.getAttribute('data-header').trim();

      if (!grouped[header]) grouped[header] = [];
      grouped[header].push(value);
      
      });

      const searchParts = Object.entries(grouped).map(([header, values]) => {
      const match = header.match(/\[(.*?)\]/);
      if (match) {
      return header.replace(/\[.*?\]/, values.join(', ')).trim();
      } else {
      return values.join(', ').trim();
      }
      });

      const query = searchParts.join(' ');
      const pinterestURL = `https://www.pinterest.com/search/pins/?q=${encodeURIComponent(query)}`;
      window.open(pinterestURL, '_blank');
      });

      title.textContent = groupTitle;
      title.appendChild(pinterestIcon);
      section.appendChild(title);

      // âœ… Append all valid tags
      validTags.forEach(({ field, value, label }) => {
      const tag = document.createElement('span');
      tag.className = 'label-tag';
      tag.setAttribute('data-field', normalizeId(field));
      tag.setAttribute('data-value', value);

      const inputEl = document.getElementById(field);
      const headerText = inputEl ? inputEl.getAttribute('data-header') : '';

      tag.setAttribute('data-header', headerText);
      tag.setAttribute('data-pinterest', inputEl?.getAttribute('data-pinterest') || headerText);
      tag.innerHTML = `${value} <span class="remove" style="cursor:pointer;">Ã—</span>`;
      section.appendChild(tag);
      });

      groupedContainer.appendChild(section);
      });
      }

      
      function removeSelection(fieldId, value) {
      const el = document.getElementById(fieldId);
      if (!el) return;

      if (el.tagName === 'SELECT') {
      Array.from(el.options).forEach(opt => {
      if (opt.value === value) opt.selected = false;
      });
      } else if (el.tagName === 'TEXTAREA') {
      if (el.value.trim() === value) el.value = '';
      }

      generatePrompt();
      updateStructuredView();
      updatePinterestQuery();
}

      
      function copyToClipboard() {
          const text = document.getElementById('finalPrompt').value;
          navigator.clipboard.writeText(text).then(() => alert('Copied!'));
        }
          const scrollableForm = document.querySelector('.scrollable-form');
          
          const outputSection = document.querySelector('.output-section');
          const canvas = document.getElementById('canvas');
          let scale = 1;
          let isDraggingCanvas = false;
          let canvasOffsetX = 0, canvasOffsetY = 0, dragStartX = 0, dragStartY = 0;
        

      async function handleSearch(selectElement, context) {
      
        }
        
        function updateLabels() {
        const keys =
        ['officeSpaceType','intendedUse','designStyle','people','furniture','materials','accentMaterials','primaryColor','accentColors','lightingType','lightingElements'];
        const labelsBox = document.getElementById('labelsBox');
        labelsBox.innerHTML = '';
        keys.forEach(id => {
        const el = document.getElementById(id);
        let values = [];

        if (el.tagName === 'SELECT' && el.multiple) {
        values = Array.from(el.selectedOptions).map(opt => opt.value); // ordered
        } else {
        values = [el.value];
        }
        values.forEach(val => {
        if (val && val.trim()) {
        const span = document.createElement('span');
        span.className = 'label-tag label-' + id;
        span.setAttribute('data-field', id);
        span.setAttribute('data-value', val);
        span.innerHTML = `${val}<span class="remove" style="margin-left:8px;cursor:pointer;">Ã—</span>`;
        labelsBox.appendChild(span);



        }
        });
        });

        }

        function updatePinterestSearchInput() {
          const allLabels = document.querySelectorAll('.right-panel .label-group .label span');
          const keywords = Array.from(allLabels).map(el => el.textContent.trim()).join(' ');
          document.querySelector('#searchBoxContainer input').value = keywords;
    }

      function removeLabel(fieldIdOrLabel, valueToRemove) {
  const fieldKey = normalizeId(fieldIdOrLabel); // always normalize
  const el = document.getElementById(fieldKey);

  // --- Update localStorage safely ---
  const saved = JSON.parse(localStorage.getItem('formValues') || '{}');

  // Match key in storage using exact match OR normalized key
  let matchedKey = Object.keys(saved).find(key => normalizeId(key) === fieldKey);

  if (matchedKey && saved[matchedKey]) {
    const current = saved[matchedKey];
    if (Array.isArray(current)) {
      saved[matchedKey] = current.filter(v => v !== valueToRemove);
      if (saved[matchedKey].length === 0) delete saved[matchedKey];
    } else if (typeof current === 'string' && current.trim() === valueToRemove) {
      delete saved[matchedKey];
    }

    localStorage.setItem('formValues', JSON.stringify(saved));
  }

  // --- Update UI if field is present ---
  if (el) {
    if (el.tagName === 'SELECT' && el.multiple) {
      Array.from(el.options).forEach(opt => {
        if (opt.value === valueToRemove) opt.selected = false;
      });
    } else if (el.tagName === 'TEXTAREA') {
      if (el.value.trim() === valueToRemove) el.value = '';
    }

    // Trigger reactive updates
    updateStructuredView();
    generatePrompt();
    updatePinterestQuery();
  }
}





function autosizePlaceholderTextareas(extraPadding = 1) {
  const textareas = document.querySelectorAll('textarea');

  textareas.forEach(textarea => {
    // Function to resize based on scrollHeight
    const resize = () => {
      textarea.style.height = '20px';//auto
      // textarea.style.height = (textarea.scrollHeight + extraPadding) + 'px';
    };

    // Initial placeholder-based sizing
    const placeholder = textarea.getAttribute('placeholder');
    if (placeholder && !textarea.value.trim()) {
      const mirror = document.createElement('div');
      const computed = window.getComputedStyle(textarea);

      Object.assign(mirror.style, {
        position: 'absolute',
        visibility: 'hidden',
        whiteSpace: 'pre-wrap',
        wordWrap: 'break-word',
        overflowWrap: 'break-word',
        padding: computed.padding,
        border: computed.border,
        font: computed.font,
        lineHeight: computed.lineHeight,
        width: textarea.offsetWidth + 'px',
      });

      mirror.textContent = placeholder;

      document.body.appendChild(mirror);
      const placeholderHeight = mirror.scrollHeight + extraPadding;
      textarea.style.height = placeholderHeight + 'px';
      document.body.removeChild(mirror);
    } else {
      // In case it already has value
      resize();
    }

    // Dynamic resizing on input
    textarea.addEventListener('input', resize);

    // Optional: Resize again on window resize (e.g., responsive layout)
    window.addEventListener('resize', resize);
  });
}











  
    function updatePinterestQuery() {
    const allFields = document.querySelectorAll('select, textarea, input');
    const promptLabels = window.promptLabels || [];
    const row4Values = window.row4Values || [];

    const phraseParts = [];

    allFields.forEach(field => {
    const fieldId = field.id;
    const index = promptLabels.findIndex(lbl => normalizeId(lbl) === normalizeId(fieldId));
    if (index === -1) return;

    const row4 = row4Values[index]?.trim();
    if (!row4 && !field.value?.trim()) return;


    let rawValue = '';
    if (field.tagName === 'SELECT' && field.multiple) {
    rawValue = Array.from(field.selectedOptions).map(opt => opt.value.trim()).filter(Boolean).join(', ');
    } else {
    rawValue = field.value.trim();
    }

    const hasPlaceholder = row4.includes('[') && row4.includes(']');

    // If it's a placeholder template but no value filled, skip
    if (hasPlaceholder && !rawValue) return;

    const finalPhrase = hasPlaceholder
    ? row4.replace(/\[(.*?)\]/g, (_, label) => rawValue)
    : row4;

    phraseParts.push(finalPhrase.trim());
    });

    // Join into one search sentence
    const finalQuery = phraseParts.length > 0
    ? phraseParts.join(' ')
    : 'photorealistic office interior inspiration';

    // Update input box
    const searchBox = document.getElementById('pinterestSearch');
    if (searchBox) {
    searchBox.value = finalQuery;
    }
    
    }

    document.querySelectorAll('select, textarea').forEach(el => {
      if (el.id === 'finalPrompt') return; // â›”ï¸ Skip the output textarea

      el.addEventListener('change', () => {
        generatePrompt();
        updateStructuredView();
        updatePinterestQuery();
      });

      if (el.tagName === 'TEXTAREA') {
        el.addEventListener('input', () => {
          generatePrompt();
          updateStructuredView();
          updatePinterestQuery();
        });
      }
    });
const observer = new MutationObserver(() => {
  updatePinterestQuery(); // âœ… This will regenerate the search string correctly
});


const rightPanel = document.querySelector('.right-panel');
  if (rightPanel) {
    observer.observe(rightPanel, {
    childList: true,
    subtree: true
  });
}





      </script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="syncForm.js"></script>




        
      </body>
      </html>