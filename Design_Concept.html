      <!DOCTYPE html>
      <html lang="en">
      <head>
        <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.3/dist/dexie.min.js"></script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Photorealistic Office Render Prompt Builder</title>
        <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
        <style>
          body {
            font-family: Arial, sans-serif!important;
            /* font-size: 18px; */
            padding: 1rem;
            background-color: #f4f2f1;
            color: white;
            overflow: hidden;
          }

 
      .container {
        display: flex;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
      }

      .scrollable-form {
          padding: 1rem 0;
          /* max-height: 90vh; */
          max-height: 92%;
          overflow-y: auto;
          flex: 0 0 35%;
          padding-right: 0.5rem; /* âœ… Reduce padding */
          margin-right: 0; /* âœ… No extra margin */
          box-sizing: border-box; /* âœ… Ensures padding doesn't add to width */
          max-width: 20%;
          }

          ::placeholder{
            font-family: Arial, sans-serif;
          }

          .form-group textarea{
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.1);
            max-width: 95%;
            color: black;
            background-color: #F4F2F1;
            border: none;
          }
          textarea:focus,
          input[type="text"]:focus {
          border: 1px solid #F0BD44 !important; /* or #ccc for soft gray */
          outline: red !important;
          }

          
          /* Scrollbar */


          /* Applies to all scrollbars in WebKit-based browsers */
          ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
          }

          ::-webkit-scrollbar-track {
            background-color: #f8f8f8;
            border-radius: 10px;
          }

          ::-webkit-scrollbar-thumb {
            background-color: rgb(197, 197, 197);
            border-radius: 10px;
            border: 2px solid #e6e6e6; /* creates spacing around thumb */
            transition: background-color 0.3s ease;
          }

          ::-webkit-scrollbar-thumb:hover {
            background-color: #F0BD44;
          }

          /* Optional: Fade into background */
          ::-webkit-scrollbar-corner {
            background-color: transparent;
          }


          .form-section {
            display: flex;
            flex-direction: column;
            
            gap: 1rem;
            width: 100%;
          }





          select[multiple], textarea, select, input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid #666;
            background: #F4F2F1;
            color: #666;
            /* font-size: 16px; */
          }
          



          .button-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
          }
          button {
            padding: 0.5rem 1.5rem;
            border-radius: 5px;
            font-weight: bold;
            border: none;
            cursor: pointer;
          }
          




      /* new */



      .pinterest-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      }

      .pinterest-row input {
      flex: 1;
      padding: 0.5rem 1rem;
      background-color: white; /* Dark background */
      color: #7c7c7c; /* Light text */
      border: none; 
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      transition: border 0.2s ease, background-color 0.2s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      #pinterestSearch::placeholder {
      color: #bebebe; /* Light gray placeholder */
      opacity: 1; /* Ensure full visibility */
      }
      /* Optional: focus effect */
      /* .pinterest-row input:focus {
      background-color: #222;
      border-color: #666;
      } */


      .pinterest-row button {
        background-color: #E60023;
        color: white;
        font-weight: bold;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .preview-placeholder {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #aaa;
        /* font-size: 16px; */
        text-align: center;
        pointer-events: none;
        user-select: none;
      }

      #furniture{
        overflow-y: auto;
        padding-right: 0.5rem;      /* Reduce padding */
        width: 100%;                /* Let it fill available width */
        box-sizing: border-box;  
      }

      .output-section {
        display: flex;
        flex-direction: column;
        width: 100%;
        overflow: hidden;
        margin: 1rem;
        padding-bottom: 2rem;
      }

      .output-main {
        display: flex;
        flex-grow: 1;
        max-height: 89%;
        overflow: hidden;
        gap: 1rem;
        padding-right:1rem;
        box-sizing: border-box;
      }



.label-tag {
  background-color: white !important;  /* Gold background */
  color: black !important;               /* Dark readable text */
  border: 2px solid #DEF5F1;             /* Optional: subtle border */
  padding: 4px 10px;
  border-radius: 6px;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}


     .remove {
        margin-left: 0.5rem;
        color: black !important;
        cursor: pointer;
        font-weight: bold;
      }

      .form-card {
        background-color: #F4F2F1;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        color: black;
        box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.05);
      }

      .form-card-header {
        font-weight: bold;
        /* font-size: 16px; */
        margin-bottom: 0.5rem;
        color: #7c7c7c!important;
      }




      .prompt-wrapper {
        
        flex: 0.85;
        height: 100%;
        overflow: auto;
        position: relative;
      }

      .output {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        font-family: Arial, sans-serif;
        font-size: 16px;
        padding: 12px;
        font-weight: medium;
        width: 100%;
        height: 100%;
        resize: none;
        /* padding: 1rem; */
        /* font-size: 16px; */
        background: white;
        color: rgb(39, 39, 39);
        border-radius: 8px;
        border: none!important;
        box-sizing: border-box;
        min-height: 100%;
      }

      .labels-box {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        width: 100%;
        flex: 0.37;
        background: #ffffff;
        color: white;
        border-radius: 8px;
        border: 0px solid #F0BD44;
        padding: 1rem;
        border-radius: 10px;
        overflow-y: auto;
        height: 100%;
        box-sizing: border-box;
        display: flex;
        flex-wrap: wrap;            /* Wrap tags to new lines */
        gap: 0.5rem;                /* Space between tags */
        align-content: flex-start;
      }

      .label-tag .remove {
        margin-left: 0.5rem;
        color: #bbb;
        cursor: pointer;
        font-weight: bold;
      }

      .output-top {
        flex: 0 0 auto;
        margin-bottom: 0.5rem;
      }

      .output-middle {
        flex: 1 1 auto;
        overflow: auto;
      }

      .output-bottom {
        flex: 0 0 auto;
        display: flex;
        gap: 0.5rem;
        align-items: center;
        padding-top: 0.5rem;
        margin-right: 1rem;
        margin-top: 1rem;
      }

      .form-group {
        /* margin-bottom: 1.5rem; */
        background-color: #ffffff;
        padding: 1rem;
        border: 0px solid #F0BD44;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .form-group h3 {
        margin-top: 0.25rem;
        padding-bottom: 0.5rem;
        /* font-size: 20px; */
        font-weight: bold;
        color: #A2A2A2;
        margin-bottom: 1px;
        border-bottom: 2px solid #555; /* Draw the horizontal line */
      }

      


      .form-card-header {
      font-weight: bold;
      /* font-size: 20px; */
      margin-bottom: 0.5rem;
      color: #ccc;
      }


      label {
        display: block;
        /* margin-top: 1rem; */
        margin-bottom: 0.5rem;
        font-weight: bold;
        
        /* font-size: 20px; */
      }

      select[multiple] {
        width: 100%;
        height: auto;
        padding: 0.5rem;
        background-color: #f4f1f1;
        /* color: black; */
        box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.05);
        border: none;
        border-radius: 5px;
      }

      select[multiple]:focus {
      border: none !important; /* or use #ccc / #999 if you prefer */
      outline: none !important;
      }
      
    

      .label-tag .remove {
        margin-left: 0.5rem;
        color: #ccc;
        font-weight: bold;
        cursor: pointer;
      }

        .grayed-out {
      pointer-events: none;
      opacity: 0.4;
      transition: opacity 0.3s ease;
    }


    .search-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    color: #A2A2A2;
    }
    
    
    

    .form-card-header i.fa-pinterest {
    margin-left: 8px;
    transition: transform 0.2s ease;
    }

    .form-card-header i.fa-pinterest:hover {
    transform: scale(1.2);
    }


    .collapsible-header {
    font-weight: bold;
    /* font-size: 22px; */
    margin-top: 0.5rem;
    cursor: pointer;
    color: black;
    border-bottom: 2px solid #555;
    padding-bottom: 1rem;
    }



.toggle-icon {
  color: black!important; /* ðŸŒŸ Teal or use #FFD700 for gold */
  font-size: 16px;
  transition: transform 0.2s ease;
}

.collapsible-content {
  margin-top: 0.75rem;
}

.toggle-icon {
  color: black!important; /* ðŸŒŸ Teal or use #FFD700 for gold */
  font-size: 20px;
  transition: transform 0.2s ease;
}

.btn {
  background-color: #00a67e;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  margin-left: 10px;
}

.label-tag {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  padding: 0.5rem 0.75rem;
  border-radius: 16px;
  /* font-size: 14px; */
  background-color: #666;
  color: white;
  display: inline-block;
  margin: 0.25rem;
  max-width: 220px;
  word-break: break-word;
  line-height: 1.3;
  cursor: pointer;              /* ðŸ‘ˆ ADD THIS */
  transition: background-color 0.2s ease;
}

.label-tag:hover {
  background-color: #888;       /* Optional hover effect */
}



.label-tag:not(.remove) {
  cursor: pointer;
}






.button-group {
  display: flex;
  gap: 1rem;
  display: flex;
  justify-content: flex-start; /* ðŸ‘ˆ All buttons start from the left */
  gap: 1rem;       
  margin-right: 2rem;
}

/* Set the same font size across all text elements */
*{
  font-size: 14px ;
}

button {
  font-size: 14px !important;
}

label {
  color: #7c7c7c!important;
  margin-top: 1rem;
}

label + textarea {
  margin-top: 0.75rem;
  /* margin-bottom: 1rem; */
  }


element.style{
margin-top: 0px;
}

.search-wrapper select {
  margin-top: 0.5rem; /* or 0.75rem for more space */
}


.button-row button,
.button-group button {
  font-size: 12px !important; /* Or 11px if you want even smaller */
  padding: 4px 10px;          /* Also reduce padding to shrink the button height */
}




.tab-bar {
  display: flex;
  gap: 8px;
  padding: 4px;
  background: transparent;
  font-size: 14px;  
  font-weight: 500;
}

.tab {
  display: flex;
  flex: 1;
  background: white;     /* Selected background */
  color: black;   
  /* border: 2px solid #F0BD44;  */
  text-align: center;
  align-items: center;
  justify-content: center;
  padding: 8px 12px;     /* Unselected background */
  color: black;          /* Unselected text */
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
  border: none;
}



.tab.active {
  background: #F0BD44;     /* Selected background */
  color: black;   
  border: 2px solid #F0BD44;  /* Selected text */
  
  border-radius: 8px;
}


.tab:hover {
  background: #F0BD44;
  color: black;
  border-color: #F0BD44; 
}

.tab.active::before {
  content: "âœ“";
  margin-right: 6px;
}





.floating-chatgpt-btn {
  position: absolute;
  bottom: 16px;
  right: 16px;
  background: #10a37f;
  color: white;
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.4);
  transition: background 0.2s ease, transform 0.1s ease;
}

.floating-chatgpt-btn:hover {
  background: #12b087;
  color: white;
  border: none;
  transform: translateY(-1px);
}






.quantity-container {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
  margin-top: 0.5rem;
}

.quantity-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background-color: #DEF5F1; /* dark background */
  border-radius: 6px;
  padding: 0.4rem 0.6rem;
}

.quantity-label {

  color: black;
  font-size: 14px;
  flex: 1;
}

.quantity-input {
  width: 60px;
  background-color: #d8d8d8;
  color: black;
  padding: 0.3rem;
  border-radius: 4px;
  text-align: center;
}


textarea::placeholder {
  color: rgba(75, 75, 75, 0.664); /* Bright cyan placeholder text */
  opacity: 1;     /* Optional: ensures full color visibility */
}





.floating-btn-container {
  position: absolute;
  bottom: 4px;
  
  right: 4px;
  display: flex;
  gap: 10px;
  z-index: 10;
}

.floating-chatgpt-btn {
  background: #DEF5F1;
  color: black;
  padding: 8px 14px;
  border: 2px solid #74d8c7;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  transition: background 0.2s ease, transform 0.1s ease;
  position: relative; /* override old absolute */
}



.floating-chatgpt-btn.reset-btn {
  background-color: #7c7c7c;
  color: white;
  border: none;
}











.placeholder-message {
  position: absolute;
  top: 50%;
  left: 88%;
  transform: translate(-50%, -50%);
  color: #666;
  font-size: 16px;
  text-align: center;
  opacity: 0.6;
  pointer-events: none;
  max-width: 300px;
}

.tab {
  text-decoration: none !important; /* removes any underline */
  -webkit-text-decoration-skip: objects;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  border: 2px solid #F2E0B7;
}

.search-wrapper Input {
  box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.05);
  background-color: #F4F2F1!important;
  border: none!important;
  color: black!important;
}



        </style>
      </head>
      <body>
      <!-- <h1>Photorealistic Office Render Prompt Builder</h1> -->
      <div class="tab-bar">
        <!-- <a class="tab" href="Meeting_Assistant.html" id="Meeting">Meeting Assistant</a> -->
        <a class="tab" href="index.html" id="Client">Client Persona</a>
        <a class="tab" href="Zoning_insights.html" id="Zoning">Zoning Insights</a>
        <a class="tab active" href="Design_Concept.html" id="Design">Design Concept</a>
        <a class="tab" href="Material.html" id="Material">Material Board</a>
        <!-- <a class="tab" href="Render_Creator.html" id="Canvas">Render Creator</a> -->
      </div>

       <div class="container">
         <div class="scrollable-form">
           <div id="formContainer" class="form-section"></div>
         </div>

         <div class="output-section">
           <div class="output-main">
             <div class="prompt-wrapper">
               <textarea class="output" id="finalPrompt"></textarea>

               <div class="floating-btn-container">

                 <button class="floating-chatgpt-btn reset-btn" onclick="resetAllFields()">
                  Reset All
                 </button>
                 <button class="floating-chatgpt-btn" id="openCustomGPT">
                   Create with AI
                 </button>
               </div>

          

             </div>

            

            <div class="labels-box" id="labelsBox">
              <!-- labels get injected here -->
               <!-- <div class="placeholder-message" id="labelsPlaceholder">Visual tags appear here as you choose design options.</div> -->

            </div>
          </div>

          <div class="output-bottom pinterest-row">
            <input type="text" id="pinterestSearch" placeholder="Search query for Pinterest"/>
            <button
              onclick="window.open('https://www.pinterest.com/search/pins/?q=' + encodeURIComponent(document.getElementById('pinterestSearch').value))">
              Open in Pinterest
            </button>
            
          </div>
        </div>
      </div>


      <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>


         <script>







// function resetAllFields() {
//   if (confirm("Clear all fields and reset the form?")) {
//     localStorage.clear(); // fully clear all keys
//     sessionStorage.setItem('resetNow', 'true'); // temporary flag
//     location.reload(); // force reload
//   }
// }

function resetAllFields() {
  if (confirm("Clear all fields and reset the form?")) {
    // Clear localStorage
    localStorage.clear();

    // Clear Dexie for this tabId
    const db = new Dexie("PromptBuilderDB");
    db.version(1).stores({
      formStates: "++id, tabId, timestamp"
    });

    const tabId = sessionStorage.getItem('tabId');
    db.formStates.where('tabId').equals(tabId).delete().then(() => {
      sessionStorage.setItem('resetNow', 'true');
      location.reload();
    });
  }
}



        const optionQuantities = {};
window.optionQuantities = optionQuantities;

// Initialize tabId once per tab
if (!sessionStorage.getItem('tabId')) {
  sessionStorage.setItem('tabId', crypto.randomUUID());
}
const tabId = sessionStorage.getItem('tabId');

// Setup Dexie
const db = new Dexie("PromptBuilderDB");
db.version(1).stores({
  formStates: "++id, tabId, timestamp"
});



async function saveToDexie() {
  const inputs = document.querySelectorAll('select, textarea');
  const savedData = {};

  inputs.forEach(el => {
    const key = el.getAttribute('data-header') || el.id;
    if (!key) return;

    if (el.tagName === 'SELECT' && el.multiple) {
      savedData[key] = Array.from(el.selectedOptions).map(opt => opt.value);
    } else if (el.tagName === 'TEXTAREA') {
      savedData[key] = el.value;
    }
  });

  // Include quantities
  savedData.__quantities = { ...window.optionQuantities };

  await db.formStates.put({
    tabId,
    timestamp: Date.now(),
    data: savedData
  });
}

// function saveQuantitiesToLocalStorage() {
//   localStorage.setItem('optionQuantities', JSON.stringify(optionQuantities));
// }

// Call this after any change
document.addEventListener('change', saveToDexie);
document.addEventListener('input', saveToDexie);




// window.addEventListener('beforeunload', (event) => {
//   if (window.skipUnloadWarning) return; // Allow silent navigation when flag is set

//   const savedData = JSON.parse(localStorage.getItem('formValues') || '{}');

//   const isFormDirty = Array.from(document.querySelectorAll('select, textarea'))
//     .some(el => {
//       const key = el.getAttribute('data-header') || el.id;
//       if (!key) return false;

//       const savedVal = savedData[key];

//       if (el.tagName === 'SELECT' && el.multiple) {
//         const currentVal = Array.from(el.selectedOptions).map(opt => opt.value);
//         return JSON.stringify(currentVal) !== JSON.stringify(savedVal || []);
//       } else {
//         const currentVal = (el.value || '').trim();
//         return currentVal !== (savedVal || '').trim();
//       }
//     });

//   if (isFormDirty) {
//     event.preventDefault();       // Required for some browsers
//     event.returnValue = '';       // Required for Chrome + modern browsers
//   }
// });

































 


// document.getElementById("Meeting").addEventListener("click", function() {
//   window.location.href = "Meeting_Assistant.html"});

       document.getElementById("Client").addEventListener("click", function() {
  window.location.href = "index.html"});

  document.getElementById("Zoning").addEventListener("click", function() {
  window.location.href = "Zoning_insights.html"});

  // document.getElementById("Canvas").addEventListener("click", function() {
  // window.location.href = "Render_Creator.html"});
  
  document.getElementById("Material").addEventListener("click", function() {
  window.location.href = "Material.html"});




     document.getElementById("openCustomGPT").addEventListener("click", function () {
const prompt = document.getElementById("finalPrompt").value.trim();
if (!prompt) {
alert("Prompt is empty!");
return;
}

// Copy to clipboard first
navigator.clipboard.writeText(prompt).then(() => {
const customGPTURL = "https://chatgpt.com/g/g-686e1d72e20c8191815036cebe628929-3-design-concept";
window.open(customGPTURL, "_blank");
alert("âœ… Prompt copied to clipboard. Just paste (Ctrl+V) into the chat.");
}).catch(() => {
alert("âŒ Failed to copy prompt. Please copy it manually.");
});
});





//       document.getElementById("openCustomGPT").addEventListener("click", function () {
// const prompt = document.getElementById("finalPrompt").value.trim();
// if (!prompt) {
// alert("Prompt is empty!");
// return;
// }

// // Copy to clipboard first
// navigator.clipboard.writeText(prompt).then(() => {
// const customGPTURL = "https://chat.openai.com/g/g-68512d8ce4208191b216c8344e406aea-design-brief-testing";
// window.open(customGPTURL, "_blank");
// alert("âœ… Prompt copied to clipboard. Just paste (Ctrl+V) into the chat.");
// }).catch(() => {
// alert("âŒ Failed to copy prompt. Please copy it manually.");
// });
// });

  
//       document.getElementById("moodboardgpt").addEventListener("click", function () {
// const prompt = document.getElementById("finalPrompt").value.trim();
// if (!prompt) {
// alert("Prompt is empty!");
// return;
// }

// // Copy to clipboard first
// navigator.clipboard.writeText(prompt).then(() => {
// const customGPTURL = "https://chatgpt.com/g/g-685d46734f708191a9f3e33e1a5f1be3-materialboard-creator";
// window.open(customGPTURL, "_blank");
// alert("âœ… Prompt copied to clipboard. Just paste (Ctrl+V) into the chat.");
// }).catch(() => {
// alert("âŒ Failed to copy prompt. Please copy it manually.");
// });
// });




    const finalPrompt = document.getElementById('finalPrompt');
    const formSection = document.querySelector('.scrollable-form');
    const Section = document.querySelector('.labels-box');

    let isManuallyEdited = false;
    let typingTimeout;

    finalPrompt.addEventListener('input', () => {
      isManuallyEdited = true;
      formSection.classList.add('grayed-out');
      Section.classList.add('grayed-out'); // for the right side as well

      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        formSection.classList.remove('grayed-out');
      }, 2000000); // Remove grey after 2 seconds of no typing


    });


    






      function normalizeId(name) {
        return name.replace(/\s+/g, '').toLowerCase();
      }
        
      // const sheetURL = 'https://docs.google.com/spreadsheets/d/1qXN1MR1pW3laS1wH_FI3vPblg3ANcqCMWVoGl0H7wek/export?format=csv';
      const sheetURL = 'https://docs.google.com/spreadsheets/d/1TtxfPpIIYBjzP32-9n9snZbNoCU69mSvYVbA3uAgGcY/export?format=csv&gid=1370946748';



      
      window.onload = async function () {
        

        const response = await fetch(sheetURL);
        const csvText = await response.text();
        const parsed = Papa.parse(csvText, { header: false });
        const data = parsed.data;

        const parentHeaders = data[0];
        const childHeaders = data[1];
        const typeRow = data[2]; // This is now the row that tells us the type (1, 2, 3)
        const contentRows = data.slice(2);
        const valueRows = data.slice(4); // Actual content starts from 4th row now
        const pinterestLabels = data[3]; // ðŸ‘ˆ This is the new row you want to use
        const quant = data.slice(4)
        const promptLabels = data[1]; // âœ… clean labels from Row 2
        window.row4Values = data[3]; // Row 4 = index 4

        window.promptLabels = promptLabels; // âœ… make accessible globally
        
const pinterestBlockFlags = data[3].map(cell => {
  return cell?.trim().toLowerCase() === 'text' && cell.toLowerCase() === cell && cell.length > 0;
});

window.pinterestBlockFlags = data[3].map((_, i) => {
  // block only if cell background was red
  return data[3][i]?.trim().toLowerCase() === 'text' && data[3][i].toLowerCase() === data[3][i];
});



        // const parentHeaders = data[0]; // Row 1 (still header group)
        // const childHeaders = data[1]; // Row 2 (still header names)
        // const typeRow = data[3]; // Row 4 â€” NEW type row
        // const valueRows = data.slice(4); // Row 5 onwards â€” values begin here


        const grouped = {};
        childHeaders.forEach((child, i) => {
          const parent = parentHeaders[i]?.trim();
          if (!parent || !child) return;
          if (!grouped[parent]) grouped[parent] = [];
          grouped[parent].push({ name: child.trim(), index: i });
        });

        const container = document.getElementById('formContainer');

        for (const [parent, children] of Object.entries(grouped)) {
        const group = document.createElement('div');
        group.className = 'form-group';

        const header = document.createElement('div');
        header.className = 'form-card-header collapsible-header';
        header.innerHTML = `
  ${parent}
  <img 
    src="data:image/png;base64,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" 
    class="toggle-icon" 
    style="float:right;cursor:pointer;width:16px;height:16px;transition:transform 0.2s ease;"
  >`;


        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'collapsible-content';
        // contentWrapper.style.display = 'none'; // ðŸ”» Hide by default


        // Toggle collapse on click
        header.addEventListener('click', () => {
  const isVisible = contentWrapper.style.display !== 'none';
  contentWrapper.style.display = isVisible ? 'none' : 'block';

  const icon = header.querySelector('.toggle-icon');
  icon.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
});


        group.appendChild(header);
        group.appendChild(contentWrapper);

        children.forEach(({ name, index }) => {
        const label = document.createElement('label');
        label.setAttribute('for', name);
        // Extract text inside [ ]
        const bracketMatch = name.match(/\[(.*?)\]/);
        label.textContent = bracketMatch ? bracketMatch[1].trim() : name.trim();

        contentWrapper.appendChild(label);


        const id = normalizeId(name);
        const hasQuantityMarker = contentRows.some(row =>
        row[index]?.trim().toLowerCase() === 'quantity'
        );

        const allValues = quant
  .map(row => row[index]?.trim())
  .filter(v => !!v && !['quantity', 'dropdown', 'text'].includes(v.toLowerCase()));


        const uniqueOptions = [...new Set(allValues)];

        let fieldElement;
if (typeRow[index]?.toLowerCase() === 'text') {
  // Pull placeholder from row 4 (valueRows[0])
  const placeholderText = valueRows[0]?.[index]?.trim() || 'Enter value here';

  const textarea = document.createElement('textarea');
  textarea.setAttribute('id', id);
  textarea.setAttribute('rows', 4);
  const pinterestLabel = pinterestLabels[index]?.trim() || name;
textarea.setAttribute('data-pinterest', pinterestLabel); 

  textarea.style.marginBottom = '0.75rem';
  textarea.placeholder = placeholderText;

  textarea.addEventListener('input', () => {
    generatePrompt();
    updateStructuredView();
    updatePinterestQuery();
  });

  fieldElement = textarea;


    } else {
      // âœ… Create search wrapper
      const searchWrapper = document.createElement('div');
      searchWrapper.classList.add('search-wrapper');

      const searchInput = document.createElement('input');
      searchInput.setAttribute('type', 'text');
      searchInput.setAttribute('placeholder', 'Search...');
      searchInput.classList.add('dropdown-search');

      const searchButton = document.createElement('button');
      searchButton.innerHTML = `<i class="fas fa-search"></i>`;
      searchButton.classList.add('search-btn');


      






      const select = document.createElement('select');
      select.setAttribute('id', id);
      select.setAttribute('multiple', true);
      const pinterestLabel = pinterestLabels[index]?.trim() || name;
select.setAttribute('data-pinterest', pinterestLabel); // âœ… ADD THIS

      select.style.marginTop = '0.5rem';

      

      uniqueOptions.forEach(value => {
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = value;
        select.appendChild(opt);
      });

      // Filter logic ðŸ”
      searchInput.addEventListener('input', () => {
        const filter = searchInput.value.toLowerCase();
        Array.from(select.options).forEach(opt => {
          opt.style.display = opt.textContent.toLowerCase().includes(filter) ? '' : 'none';
        });
      });

      searchButton.addEventListener('click', () => {
        const filter = searchInput.value.toLowerCase();
        Array.from(select.options).forEach(opt => {
          opt.style.display = opt.textContent.toLowerCase().includes(filter) ? '' : 'none';
        });
      });
      select.addEventListener('change', () => {
      moveSelectedOptionsToTop(select);
      if (quantityContainer) {
      updateQuantitiesForSelect(select, quantityContainer, id);

      }


      generatePrompt();
      updateStructuredView();
      updatePinterestQuery();
      });


      searchInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault(); // Prevent form submission

        const inputValue = searchInput.value.trim();
        if (!inputValue) return;

        const exists = Array.from(select.options).some(option =>
          option.text.toLowerCase() === inputValue.toLowerCase()
        );

        if (!exists) {
          const newOption = document.createElement('option');
          newOption.value = inputValue;
          newOption.text = inputValue;
          newOption.selected = true;
          select.appendChild(newOption);
        } else {
          // If it exists, select it
          Array.from(select.options).forEach(option => {
            if (option.text.toLowerCase() === inputValue.toLowerCase()) {
              option.selected = true;
            }
          });
        }

        // Reset input and regenerate prompt
        searchInput.value = '';
        moveSelectedOptionsToTop(select);
        generatePrompt();
        updateStructuredView();
        updatePinterestQuery();
      }
    });


    // Create top row for label + search input in same row
    const topRow = document.createElement('div');
    topRow.style.display = 'flex';
    topRow.style.alignItems = 'center';
    topRow.style.justifyContent = 'space-between';
    // topRow.style.marginTop = '15px';
    topRow.style.gap = '1rem';

    // Create and style label
    label.style.color = '#ccc';
    label.style.fontWeight = 'bold';
    label.style.flex = '1';

    // Wrapper for search input + icon
    const inputWrapper = document.createElement('div');
    inputWrapper.style.display = 'flex';
    inputWrapper.style.alignItems = 'center';
    inputWrapper.style.flex = '1';
    inputWrapper.style.gap = '6px'; // gap between input and icon

    // Style search input
    searchInput.style.flex = '1';
    searchInput.style.minWidth = '120px';
    searchInput.style.padding = '6px 8px';
    searchInput.style.border = '1px solid #444';
    searchInput.style.borderRadius = '4px';
    searchInput.style.background = '#222';
    searchInput.style.color = '#fff';


    // Build structure
    inputWrapper.appendChild(searchInput);
    // inputWrapper.appendChild(searchButton);
    topRow.appendChild(label);
    topRow.appendChild(inputWrapper);
    group.appendChild(topRow);  // âœ… fixed



    searchWrapper.appendChild(topRow);

// Wrap the select in a div to add spacing
const selectWrapper = document.createElement('div');
// selectWrapper.style.marginTop = '0.75rem'; // Adjust spacing here
selectWrapper.style.marginBottom = '1rem';
selectWrapper.appendChild(select);

// Create container for dynamic quantity inputs
let quantityContainer = null;
if (hasQuantityMarker) {
  const qc = document.createElement('div');
  qc.className = 'quantity-container';
  qc.style.display = 'flex';
  qc.style.flexDirection = 'column';
  qc.style.gap = '0.3rem';
  qc.style.marginTop = '0.5rem';
  quantityContainer = qc;

  // Append below the select
  searchWrapper.appendChild(quantityContainer);
}


searchWrapper.appendChild(selectWrapper);


    fieldElement = searchWrapper;


    }

        fieldElement.setAttribute('data-header', name); // âœ… Set the label for dynamic Pinterest queries

        contentWrapper.appendChild(fieldElement);



        
      });


          container.appendChild(group);
        }

        autosizePlaceholderTextareas(-10);// adds 6px of extra space
      };

async function restoreFromDexie() {
  const record = await db.formStates.where('tabId').equals(tabId).last();
  if (!record?.data) return;

  const data = record.data;

  // Restore input values
  document.querySelectorAll('select, textarea').forEach(el => {
    const key = el.getAttribute('data-header') || el.id;
    if (!key || !(key in data)) return;

    if (el.tagName === 'SELECT' && el.multiple && Array.isArray(data[key])) {
      Array.from(el.options).forEach(option => {
        option.selected = data[key].includes(option.value);
      });
    } else if (el.tagName === 'TEXTAREA') {
      el.value = data[key];
    }

    el.dispatchEvent(new Event('change'));
  });

  // Restore optionQuantities if available
  if (data.__quantities) {
    Object.assign(window.optionQuantities, data.__quantities);

    // Update counters
    document.querySelectorAll('select[multiple]').forEach(select => {
      const fieldId = normalizeId(select.id);
      const container = select.closest('.search-wrapper')?.querySelector('.quantity-container');
      if (container && window.optionQuantities[fieldId]) {
        updateQuantitiesForSelect(select, container, fieldId);
      }
    });
  }

  // Regenerate prompts or tags if needed
  generatePrompt();
  updateStructuredView();
  updatePinterestQuery();
}








// Run this after all elements are rendered
const wasReset = sessionStorage.getItem('resetNow') === 'true';

if (!wasReset) {
  setTimeout(async () => {
    await restoreFromDexie();
    restoreQuantitiesFromLocalStorage(); // still uses localStorage unless you Dexie it too
  }, 1100);
}
 else {
  sessionStorage.removeItem('resetNow'); // clear flag so next load behaves normally  
}






    



    document.getElementById('labelsBox').addEventListener('click', function (e) {
      const tag = e.target.closest('.label-tag');
      if (!tag) return;

      // ðŸ—‘ Remove logic
      if (e.target.classList.contains('remove')) {
      const field = tag.getAttribute('data-field');
      const value = tag.getAttribute('data-value');
      if (field && value) removeLabel(field, value);
      return;
      }

      // ðŸ§  Pinterest search (dynamic, same as icon)
      const section = tag.closest('.form-card');
      const tagElements = section.querySelectorAll('.label-tag');
      if (tagElements.length === 0) return;
    const grouped = {};
    const value = tag.getAttribute('data-value')?.trim();
    const header = tag.getAttribute('data-pinterest')?.trim() || tag.getAttribute('data-header')?.trim();
    if (!value || !header) return;

    const query = header.includes('[')
    ? header.replace(/\[.*?\]/, value)
    : `${header} ${value}`;

    const pinterestURL = `https://www.pinterest.com/search/pins/?q=${encodeURIComponent(query)}`;
    window.open(pinterestURL, '_blank');


      const searchParts = Object.entries(grouped).map(([header, values]) => {
      const match = header.match(/\[(.*?)\]/);
      if (match) {
      return header.replace(/\[.*?\]/, values.join(', ')).trim();
      } else {
      return values.join(', ').trim();
      }
      });

      // const query = searchParts.join(' ');
      // const pinterestURL = `https://www.pinterest.com/search/pins/?q=${encodeURIComponent(query)}`;
      window.open(pinterestURL, '_blank');
      });


  


      


      function dataURLtoFile(dataurl, filename) {
        const arr = dataurl.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) u8arr[n] = bstr.charCodeAt(n);
        return new File([u8arr], filename, { type: mime });
      }


        async function exportToChatGPT() {
        const prompt = document.getElementById('finalPrompt').value;
        const wrappers = document.querySelectorAll('.preview-image-wrapper');

          const labelled = Array.from(wrappers)
            .filter(wrapper => wrapper.querySelector('.image-label') && wrapper.querySelector('img'))
            .map(wrapper => {
              const label = wrapper.querySelector('.image-label').textContent.trim();
              const img = wrapper.querySelector('img');
              const base64 = img.src.split(',')[1]; // Extract base64 only
              return { label, base64 };
            });

          if (labelled.length === 0) {
          // Proceed without images
          const prompt = document.getElementById('finalPrompt').value;
          const chatGPTURL = `https://chatgpt.com/g/g-686e0c310aac81919183673ef60ae018-1-client-persona-gpt`;
          window.open(chatGPTURL, "_blank");
          return;
          }


          const uploads = await Promise.all(labelled.map(async ({ label, base64 }) => {
            try {
              const res = await fetch("https://api.imgbb.com/1/upload", {
                method: "POST",
                body: new URLSearchParams({
                  key: "e4440d61f8e0b97bfe979bf8995476c2", // your API key
                  image: base64
                })
              });
              const data = await res.json();
              if (data.success) {
                const url = data.data.url;
                return `\n ${label} :${url}`;
              } else {
                return `**${label}**: (upload failed)`;
              }
            } catch (e) {
              return `**${label}**: (upload error)`;
            }
          }));

        const combinedPrompt = `${prompt}\n\n${uploads.join("\n\n")}`;
        const chatGPTURL = `https://chat.openai.com/?prompt=${encodeURIComponent(combinedPrompt)}`;
        window.open(chatGPTURL, "_blank");
      }

      // Normalize select options to keep selected at the top
      function moveSelectedOptionsToTop(selectElement) {
        const selected = Array.from(selectElement.selectedOptions);
        const unselected = Array.from(selectElement.options).filter(opt => !opt.selected);

        selectElement.innerHTML = '';

        selected.forEach(opt => {
          const o = new Option(opt.text, opt.value, false, true);
          selectElement.appendChild(o);
        });

        unselected.forEach(opt => {
          const o = new Option(opt.text, opt.value, false, false);
          selectElement.appendChild(o);
        });
      }

      // Hook moveSelectedOptionsToTop on all select changes
      function attachMoveSelectedTop() {
        document.querySelectorAll('select[multiple]').forEach(select => {
          select.addEventListener('change', () => moveSelectedOptionsToTop(select));
        });
      }

      // Ensure it's run after dynamic form generation
      setTimeout(attachMoveSelectedTop, 1000);


        function openInChatGPT() {
        const prompt = document.getElementById('finalPrompt').value.trim();
        if (!prompt) {
          alert("Prompt is empty!");
          return;
        }
        const encodedPrompt = encodeURIComponent(prompt);
        const chatURL = `https://chat.openai.com/?model=text-davinci-003&prompt=${encodedPrompt}`;
        window.open(chatURL, '_blank');
      }

        document.querySelectorAll('select, textarea').forEach(el => {
        el.addEventListener('change', generatePrompt);
      });


function normalizeLabel(label) {
  return label.replace(/\s+/g, '').toLowerCase();
}




function getMultiSelect(labelInBrackets) {
  const normalizedInput = normalizeLabel(labelInBrackets);
  const match = Array.from(document.querySelectorAll('select[multiple]')).find(select => {
    const header = select.getAttribute('data-header') || '';
    const bracket = header.match(/\[(.*?)\]/);
    if (bracket) {
      return normalizeLabel(bracket[1]) === normalizedInput;
    }
    // No brackets: fallback to full header text
    return normalizeLabel(header) === normalizedInput;
  });
  if (!match) return [];
  return Array.from(match.selectedOptions).map(opt => opt.value.trim()).filter(Boolean);
}




function get(labelInBrackets) {
  const normalizedInput = normalizeLabel(labelInBrackets);
  const match = Array.from(document.querySelectorAll('select, textarea')).find(el => {
    const header = el.getAttribute('data-header') || '';
    const bracket = header.match(/\[(.*?)\]/);
    if (bracket) {
      return normalizeLabel(bracket[1]) === normalizedInput;
    }
    return normalizeLabel(header) === normalizedInput;
  });
  if (!match) return '';
  if (match.tagName === 'SELECT') {
    return Array.from(match.selectedOptions).map(opt => opt.value.trim()).join(', ');
  }
  return match.value.trim();
}



function getValueByLabel(labelInBrackets) {
  const normalizedInput = normalizeLabel(labelInBrackets);
  const match = Array.from(document.querySelectorAll('select, textarea')).find(el => {
    const header = el.getAttribute('data-header') || '';
    const bracket = header.match(/\[(.*?)\]/);
    if (bracket) {
      return normalizeLabel(bracket[1]) === normalizedInput;
    }
    return normalizeLabel(header) === normalizedInput;
  });
  if (!match) return [];
  if (match.tagName === 'SELECT' && match.multiple) {
    return Array.from(match.selectedOptions).map(opt => opt.value.trim()).filter(Boolean);
  }
  if (match.tagName === 'TEXTAREA') {
    const val = match.value.trim();
    return val ? [val] : [];
  }
  return [];
}


console.log("ðŸ” generatePrompt triggered");




        
 function generatePrompt() {
  console.log("Field IDs in optionQuantities:", Object.keys(window.optionQuantities));

  const lines = [];

  const allInputs = document.querySelectorAll('select, textarea');

  allInputs.forEach((el, i) => {
    const label = window.promptLabels?.[i]?.trim() ||
                  el.getAttribute('data-pinterest')?.trim() ||
                  el.getAttribute('data-header')?.trim();
    if (!label) return;

    if (window.pinterestBlockFlags && window.pinterestBlockFlags[i] === true) return;


    const fieldId = normalizeId(el.id);
    const quantityMap = window.optionQuantities?.[fieldId] || {};
    const values = [];

    // Handle select with quantity
    if (el.tagName === 'SELECT' && el.multiple) {
      Array.from(el.selectedOptions).forEach(opt => {
        const val = opt.value.trim();
        if (!val) return;
        const qty = quantityMap[val];
        if (qty && Number(qty) > 1) {
          values.push(`${val} (${qty})`);
        } else {
          values.push(val);
        }
      });
    }

    // Handle textarea
    if (el.tagName === 'TEXTAREA') {
      const val = el.value.trim();
      if (val) values.push(val);
    }

    if (values.length > 0) {
      lines.push(`${label}: ${values.join(', ')}`);
    }
  });

 if (!isManuallyEdited) {
  const promptArea = document.getElementById('finalPrompt');
  if (promptArea) {
    promptArea.value = lines.join('\n\n');
  }
}

}


    
    function updateQuantitiesForSelect(selectEl, quantityContainer, fieldId) {
    // Clear previous
    quantityContainer.innerHTML = '';

    const selectedOptions = Array.from(selectEl.selectedOptions);
    if (selectedOptions.length === 0) return;

    if (!optionQuantities[fieldId]) optionQuantities[fieldId] = {};

    selectedOptions.forEach(opt => {
    const val = opt.value.trim();

    if (!optionQuantities[fieldId]) {
  optionQuantities[fieldId] = {};
}
if (!optionQuantities[fieldId][val]) {
  const savedQty = window.optionQuantities?.[fieldId]?.[val];
  optionQuantities[fieldId][val] = savedQty || 1;
}


    const row = document.createElement('div');
    row.className = 'quantity-row'; // NEW CLASS

    const lbl = document.createElement('span');
    lbl.textContent = val;
    lbl.className = 'quantity-label'; // NEW CLASS

    const qty = document.createElement('input');
    qty.type = 'number';
    qty.min = '1';
    qty.value = optionQuantities[fieldId][val];
    qty.className = 'quantity-input'; // NEW CLASS

    qty.addEventListener('input', () => {
    const v = parseInt(qty.value, 10);
    if (!isNaN(v) && v >= 1) {
    optionQuantities[fieldId][val] = v;
 
    generatePrompt();
    saveQuantitiesToLocalStorage();

    updateStructuredView();
    updatePinterestQuery();
    }
    });

    row.appendChild(lbl);
    row.appendChild(qty);
    quantityContainer.appendChild(row);
    });
    }




      setTimeout(() => {
        document.querySelectorAll('select[multiple]').forEach(select => { 
          select.addEventListener('change', generatePrompt);
        });
      }, 500); // slight delay to wait for selects to render


      function updateStructuredView() {
      const groupedContainer = document.getElementById('labelsBox');
      groupedContainer.innerHTML = '';

      const formGroups = document.querySelectorAll('.form-group');
      formGroups.forEach(group => {
      const header = group.querySelector('div');
      if (!header) return;
      const groupTitle = header.childNodes[0].textContent.trim();
      const fields = group.querySelectorAll('select, textarea');

      const validTags = [];

      fields.forEach(el => {
      const fieldId = el.id;
      const inputEl = document.getElementById(fieldId);

      const fieldIndex = window.promptLabels.findIndex(
      lbl => normalizeId(lbl) === normalizeId(fieldId)
      );
      const row4Value = (fieldIndex !== -1) ? (window.row4Values?.[fieldIndex]?.trim()) : null;

      if (!row4Value) return; // ðŸš« Skip field if Row 4 is empty

      if (el.tagName === 'SELECT' && el.multiple) {
      const options = Array.from(el.selectedOptions);
      options.forEach(opt => {
      const value = opt.value.trim();
      if (value) {
      validTags.push({
      field: fieldId,
      value,
      label: row4Value
      });
      }
      });
      } else if ((el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') && el.value.trim()) {
      validTags.push({
      field: fieldId,
      value: el.value.trim(),
      label: row4Value
      });
      }
      });

      // ðŸš« Skip rendering the entire card if no valid tags
      if (validTags.length === 0) return;

      // âœ… Create the card
      const section = document.createElement('div');
      section.classList.add('form-card');

      const title = document.createElement('div');
      title.classList.add('form-card-header');

      // Pinterest Icon
      const pinterestIcon = document.createElement('i');
      pinterestIcon.className = 'fa-brands fa-pinterest';
      pinterestIcon.style.cursor = 'pointer';
      pinterestIcon.style.float = 'right';
      pinterestIcon.title = 'Search on Pinterest';
      pinterestIcon.style.color = '#E60023';
      pinterestIcon.style.fontSize = '20px';

      pinterestIcon.addEventListener('click', () => {
      const tagElements = section.querySelectorAll('.label-tag');
      if (tagElements.length === 0) return;

      const grouped = {};
      tagElements.forEach(tag => {
      const value = tag.getAttribute('data-value').trim();
      const header = tag.getAttribute('data-pinterest')?.trim() || tag.getAttribute('data-header').trim();

      if (!grouped[header]) grouped[header] = [];
      grouped[header].push(value);
      
      });

      const searchParts = Object.entries(grouped).map(([header, values]) => {
      const match = header.match(/\[(.*?)\]/);
      if (match) {
      return header.replace(/\[.*?\]/, values.join(', ')).trim();
      } else {
      return values.join(', ').trim();
      }
      });

      const query = searchParts.join(' ');
      const pinterestURL = `https://www.pinterest.com/search/pins/?q=${encodeURIComponent(query)}`;
      window.open(pinterestURL, '_blank');
      });

      title.textContent = groupTitle;
      title.appendChild(pinterestIcon);
      section.appendChild(title);

      // âœ… Append all valid tags
      validTags.forEach(({ field, value, label }) => {
      const tag = document.createElement('span');
      tag.className = 'label-tag';
      tag.setAttribute('data-field', normalizeId(field));
      tag.setAttribute('data-value', value);

      const inputEl = document.getElementById(field);
      const headerText = inputEl ? inputEl.getAttribute('data-header') : '';

      tag.setAttribute('data-header', headerText);
      tag.setAttribute('data-pinterest', inputEl?.getAttribute('data-pinterest') || headerText);
      tag.innerHTML = `${value} <span class="remove" style="cursor:pointer;">Ã—</span>`;
      section.appendChild(tag);
      });

      groupedContainer.appendChild(section);
      });
      }

      
      function removeSelection(fieldId, value) {
      const el = document.getElementById(fieldId);
      if (!el) return;

      if (el.tagName === 'SELECT') {
      Array.from(el.options).forEach(opt => {
      if (opt.value === value) opt.selected = false;
      });
      } else if (el.tagName === 'TEXTAREA') {
      if (el.value.trim() === value) el.value = '';
      }

      generatePrompt();
      updateStructuredView();
      updatePinterestQuery();
}

      
      function copyToClipboard() {
          const text = document.getElementById('finalPrompt').value;
          navigator.clipboard.writeText(text).then(() => alert('Copied!'));
        }
          const scrollableForm = document.querySelector('.scrollable-form');
          
          const outputSection = document.querySelector('.output-section');
          const canvas = document.getElementById('canvas');
          let scale = 1;
          let isDraggingCanvas = false;
          let canvasOffsetX = 0, canvasOffsetY = 0, dragStartX = 0, dragStartY = 0;
        

      async function handleSearch(selectElement, context) {
      
        }
        
        function updateLabels() {
        const keys =
        ['officeSpaceType','intendedUse','designStyle','people','furniture','materials','accentMaterials','primaryColor','accentColors','lightingType','lightingElements'];
        const labelsBox = document.getElementById('labelsBox');
        labelsBox.innerHTML = '';
        keys.forEach(id => {
        const el = document.getElementById(id);
        let values = [];

        if (el.tagName === 'SELECT' && el.multiple) {
        values = Array.from(el.selectedOptions).map(opt => opt.value); // ordered
        } else {
        values = [el.value];
        }
        values.forEach(val => {
        if (val && val.trim()) {
        const span = document.createElement('span');
        span.className = 'label-tag label-' + id;
        span.setAttribute('data-field', id);
        span.setAttribute('data-value', val);
        span.innerHTML = `${val}<span class="remove" style="margin-left:8px;cursor:pointer;">Ã—</span>`;
        labelsBox.appendChild(span);



        }
        });
        });

        }

        function updatePinterestSearchInput() {
          const allLabels = document.querySelectorAll('.right-panel .label-group .label span');
          const keywords = Array.from(allLabels).map(el => el.textContent.trim()).join(' ');
          document.querySelector('#searchBoxContainer input').value = keywords;
    }

//       function removeLabel(fieldIdOrLabel, valueToRemove) {
//   const fieldKey = normalizeId(fieldIdOrLabel); // always normalize
//   const el = document.getElementById(fieldKey);

//   // --- Update localStorage safely ---
//   const saved = JSON.parse(localStorage.getItem('formValues') || '{}');

//   // Match key in storage using exact match OR normalized key
//   let matchedKey = Object.keys(saved).find(key => normalizeId(key) === fieldKey);

//   if (matchedKey && saved[matchedKey]) {
//     const current = saved[matchedKey];
//     if (Array.isArray(current)) {
//       saved[matchedKey] = current.filter(v => v !== valueToRemove);
//       if (saved[matchedKey].length === 0) delete saved[matchedKey];
//     } else if (typeof current === 'string' && current.trim() === valueToRemove) {
//       delete saved[matchedKey];
//     }

//     localStorage.setItem('formValues', JSON.stringify(saved));
//   }

//   // --- Update UI if field is present ---
//   if (el) {
//     if (el.tagName === 'SELECT' && el.multiple) {
//       Array.from(el.options).forEach(opt => {
//         if (opt.value === valueToRemove) opt.selected = false;
//       });
//     } else if (el.tagName === 'TEXTAREA') {
//       if (el.value.trim() === valueToRemove) el.value = '';
//     }

//     // Trigger reactive updates
//     updateStructuredView();
//     generatePrompt();
//     updatePinterestQuery();
//   }
// }


function removeLabel(fieldIdOrLabel, valueToRemove) {
  const fieldKey = normalizeId(fieldIdOrLabel); // always normalize
  const el = document.getElementById(fieldKey);

  // --- Remove from Dexie in-memory optionQuantities ---
  if (window.optionQuantities?.[fieldKey]) {
    delete window.optionQuantities[fieldKey][valueToRemove];
    if (Object.keys(window.optionQuantities[fieldKey]).length === 0) {
      delete window.optionQuantities[fieldKey];
    }
  }

  // --- Update UI if field is present ---
  if (el) {
    if (el.tagName === 'SELECT' && el.multiple) {
      Array.from(el.options).forEach(opt => {
        if (opt.value === valueToRemove) opt.selected = false;
      });
    } else if (el.tagName === 'TEXTAREA') {
      if (el.value.trim() === valueToRemove) el.value = '';
    }

    // Force refresh
    const event = new Event('change', { bubbles: true });
    el.dispatchEvent(event);
  }

  // Update all views and storage
  generatePrompt();
  updateStructuredView();
  updatePinterestQuery();
  saveToDexie();
}



function autosizePlaceholderTextareas(extraPadding = 1) {
  const textareas = document.querySelectorAll('textarea');

  textareas.forEach(textarea => {
    // Function to resize based on scrollHeight
    const resize = () => {
      textarea.style.height = '20px';//auto
      // textarea.style.height = (textarea.scrollHeight + extraPadding) + 'px';
    };

    // Initial placeholder-based sizing
    const placeholder = textarea.getAttribute('placeholder');
    if (placeholder && !textarea.value.trim()) {
      const mirror = document.createElement('div');
      const computed = window.getComputedStyle(textarea);

      Object.assign(mirror.style, {
        position: 'absolute',
        visibility: 'hidden',
        whiteSpace: 'pre-wrap',
        wordWrap: 'break-word',
        overflowWrap: 'break-word',
        padding: computed.padding,
        border: computed.border,
        font: computed.font,
        lineHeight: computed.lineHeight,
        width: textarea.offsetWidth + 'px',
      });

      mirror.textContent = placeholder;

      document.body.appendChild(mirror);
      const placeholderHeight = mirror.scrollHeight + extraPadding;
      textarea.style.height = placeholderHeight + 'px';
      document.body.removeChild(mirror);
    } else {
      // In case it already has value
      resize();
    }

    // Dynamic resizing on input
    textarea.addEventListener('input', resize);

    // Optional: Resize again on window resize (e.g., responsive layout)
    window.addEventListener('resize', resize);
  });
}


    








    function updatePinterestQuery() {
    const allFields = document.querySelectorAll('select, textarea, input');
    const promptLabels = window.promptLabels || [];
    const row4Values = window.row4Values || [];

    const phraseParts = [];

    allFields.forEach(field => {
    const fieldId = field.id;
    const index = promptLabels.findIndex(lbl => normalizeId(lbl) === normalizeId(fieldId));
    if (index === -1) return;

    const row4 = row4Values[index]?.trim();
    if (!row4 && !field.value?.trim()) return;


    let rawValue = '';
    if (field.tagName === 'SELECT' && field.multiple) {
    rawValue = Array.from(field.selectedOptions).map(opt => opt.value.trim()).filter(Boolean).join(', ');
    } else {
    rawValue = field.value.trim();
    }

    const hasPlaceholder = row4.includes('[') && row4.includes(']');

    // If it's a placeholder template but no value filled, skip
    if (hasPlaceholder && !rawValue) return;

    const finalPhrase = hasPlaceholder
    ? row4.replace(/\[(.*?)\]/g, (_, label) => rawValue)
    : row4;

    phraseParts.push(finalPhrase.trim());
    });

    // Join into one search sentence
    const finalQuery = phraseParts.length > 0
    ? phraseParts.join(' ')
    : 'photorealistic office interior inspiration';

    // Update input box
    const searchBox = document.getElementById('pinterestSearch');
    if (searchBox) {
    searchBox.value = finalQuery;
    }
   
    }

    document.querySelectorAll('select, textarea').forEach(el => {
      if (el.id === 'finalPrompt') return; // â›”ï¸ Skip the output textarea

      el.addEventListener('change', () => {
        generatePrompt();
        updateStructuredView();
        updatePinterestQuery();
      });

      if (el.tagName === 'TEXTAREA') {
        el.addEventListener('input', () => {
          generatePrompt();
          updateStructuredView();
          updatePinterestQuery();
        });
      }
    });
const observer = new MutationObserver(() => {
  updatePinterestQuery(); // âœ… This will regenerate the search string correctly
});


const rightPanel = document.querySelector('.right-panel');
  if (rightPanel) {
    observer.observe(rightPanel, {
    childList: true,
    subtree: true
  });
}

// 1. Run once when DOM is ready (initial load)
window.addEventListener('DOMContentLoaded', () => {
  restoreFromLocalStorage();
  restoreQuantitiesFromLocalStorage();
  generatePrompt();              // âœ… this fills the prompt on first load
  updateStructuredView();
  updatePinterestQuery();
});

// 2. Run again when tab regains focus (after switching)
window.addEventListener('focus', () => {
  generatePrompt();              // âœ… acts as backup refresher
  updateStructuredView();
  updatePinterestQuery();
});




      </script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>




        
      </body>
      </html>